#!/bin/bash
# ===========================================================
# üîµ ANOVA Œ≤ ‚Äî Sistema di sicurezza merge intelligente
# Controlla conflitti e impedisce merge sporchi o non sicuri
# ===========================================================

# Messaggio iniziale
echo ""
echo "üß†  Avvio controllo merge automatico..."
echo "-------------------------------------------"

# Controlla se ci sono conflitti in corso
if git diff --check --cached | grep -q "conflict"; then
  echo "‚ùå Conflitti di merge rilevati! Risolvili prima di procedere."
  echo "-------------------------------------------"
  exit 1
fi

# Controlla se ci sono file non aggiunti
if ! git diff --quiet; then
  echo "‚ö†Ô∏è  Ci sono modifiche locali non committate."
  echo "üëâ  Esegui prima: git add . && git commit -m 'messaggio'"
  echo "-------------------------------------------"
  exit 1
fi

# Controlla se la branch √® aggiornata con main
git fetch origin main >/dev/null 2>&1
if ! git diff --quiet HEAD origin/main; then
  echo "‚ö†Ô∏è  Il branch locale non √® aggiornato con 'main'."
  echo "üëâ  Esegui prima: git pull origin main"
  echo "-------------------------------------------"
  exit 1
fi

# Se tutto √® ok
echo "‚úÖ Nessun conflitto o problema rilevato."
echo "‚úÖ Merge consentito."
echo "-------------------------------------------"
exit 0
